#!/bin/bash
# Скрипт для vpn соединения через network manager
# Ждет, пока кабель будет отключен
# Автоматический реконект при нерабочей сети/интернете

# Имена интерфейсов
PPP="ppp0"
ETH="eth0"
# UUID подключения по проводной сети
ETH_UUID="73ea227c-25d4-4b08-93ac-f2ccdab5d870"
# UUID подключения по VPN
VPN_UUID="38be0e58-00b0-448b-8440-040d64f44730"

function Main
{
    if EthAvailable; then
	if [ "$(nmcli -t -f uuid con status)" ]; then
	    if [ "$(nmcli con status| grep $ETH_UUID)" ]; then
		if NetUp; then
		    if [ "$(nmcli con status |grep $VPN_UUID)" ]; then
			until InetUp; do
			    sleep 1s
			done
		    else
			nmcli con up uuid $VPN_UUID >/dev/null 2>&1
			sleep 10s
		    fi
		else
	    	    nmcli con down uuid $ETH_UUID >/dev/null 2>&1
		fi
	    else
		sleep 10s
	    fi
	else
    	    nmcli con up uuid $ETH_UUID >/dev/null 2>&1
	    sleep 1s
	fi
    else
	sleep 1s
    fi
}

function EthAvailable
{
    case "$(nmcli -t -f device,state dev |grep $ETH)" in
	"$ETH:отключено")
	    return 0
	    ;;
	"$ETH:подключено")
	    return 0
	    ;;
	*)
	    return 1
	    ;;
    esac
}

function NetUp
{
    ping -I $ETH -c 3 google.com >/dev/null 2>&1
    if [ $? == "0" ]; then
	return 1
    else
	return 0
    fi
}

function InetUp
{
    ping -I $PPP -c 10 google.com >/dev/null 2>&1
    if [ $? == "0" ]; then
	return 1
    else
	return 0
    fi
}

while [ 1 ]; do
    Main
    sleep 1s
done
